language: python
python:
  - "2.7"
sudo: true

before_install:
  - git clone -b 3.2 https://github.com/antirez/redis vendor/redis
  - (cd vendor/redis; make && sudo make install)
  - echo -e '\n\n\n\n\n\n' | sudo ./vendor/redis/utils/install_server.sh

install:
  - pip install pipenv
  - pipenv install
  - if [ $LEGACY_REDIS -eq 1 ]; then pipenv run pip install redis==2.10.6; fi

env:
  - LEGACY_REDIS=0
  - LEGACY_REDIS=1

script:
  - pipenv run python setup.py test

jobs:
  include:
    - stage: deploy
      provider: script
      on:
        branch: master
      script:
        - make -C docs html
        - ghp-import -n docs/_build/html
        - git push -fq https://$GH_TOKEN@github.com/$TRAVIS_REPO_SLUG.git gh-pages
